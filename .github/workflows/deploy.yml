name: Test & Deploy to VPS (PM2 Mode)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS (PM2)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only deploy on main branch
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Deploy and Restart with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /srv/marvel || exit 1
            git pull
            # Navigate to frontend directory
            echo ""
            echo "üìÇ Moving to frontend directory..."
            cd frontend || exit 1
            echo "‚úÖ Now in: $(pwd)"
            
            # Install dependencies
            echo ""
            echo "üì¶ Installing dependencies with npm ci..."
            npm ci
            echo "‚úÖ Dependencies installed"
            echo "üìä Package count: $(npm list --depth=0 2>/dev/null | wc -l)"
            
            # Build project
            echo ""
            echo "üèóÔ∏è Building Next.js project..."
            npm run build
            echo "‚úÖ Build complete"
            
            # Show current PM2 status
            echo "üìä Current PM2 processes:"
            pm2 list || echo "No PM2 processes running yet"
            
            # Start or restart with PM2 using ecosystem config
            echo ""
            echo "üöÄ Starting/Restarting with PM2..."
            if pm2 list | grep -q "frontend"; then
              echo "‚ôªÔ∏è  Restarting existing PM2 process..."
              pm2 restart ecosystem.config.js
            else
              echo "‚ñ∂Ô∏è  Starting new PM2 process..."
              pm2 start ecosystem.config.js
            fi
            
            # Save PM2 config
            echo "üíæ Saving PM2 configuration..."
            pm2 save
            
            # Show final status
            echo ""
            echo "==================================="
            echo "üìä Final PM2 Status:"
            echo "==================================="
            pm2 list
            echo ""
            echo "üìù PM2 Logs (last 10 lines):"
            pm2 logs frontend --lines 10 --nostream || echo "Logs not available yet"
            
            echo ""
            echo "==================================="
            echo "‚úÖ DEPLOYMENT COMPLETE!"
            echo "==================================="
            echo "App: frontend"
            echo "Status: $(pm2 show frontend | grep 'status' | awk '{print $4}')"
            echo "Memory: $(pm2 show frontend | grep 'memory' | head -1 | awk '{print $4}')"
            echo "PID: $(pm2 show frontend | grep 'pid' | awk '{print $4}')"
            echo "Uptime: $(pm2 show frontend | grep 'uptime' | awk '{print $4}')"
            echo "==================================="
      
      - name: Verify Deployment
        run: |
          echo "==================================="
          echo "üîç Final Verification"
          echo "==================================="
          echo "Waiting 5 seconds for server to start..."
          sleep 5
          
          # Try to check if site is responding
          echo "Testing site availability..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:3002 || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ SUCCESS: Site is live on port 3002 (HTTP 200)"
          else
            echo "‚ÑπÔ∏è  Site returned HTTP $HTTP_STATUS (may still be starting)"
            echo "Check PM2 logs on VPS for details"
          fi
          
          echo ""
          echo "==================================="
          echo "üéâ PM2 DEPLOYMENT COMPLETE!"
          echo "==================================="
          echo "Site URL: http://${{ secrets.VPS_HOST }}:3002"
          echo "Deployed at: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "By: ${{ github.actor }}"
          echo "==================================="
          echo ""
          echo "üí° Useful commands on VPS:"
          echo "  pm2 logs frontend         # View logs"
          echo "  pm2 status                # Check status"
          echo "  pm2 restart frontend      # Restart app"
          echo "==================================="
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "==================================="
          echo "üìã DEPLOYMENT SUMMARY"
          echo "==================================="
          echo "Status: ${{ job.status }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "VPS Path: /srv/marvel"
          echo "Frontend Path: /srv/marvel/frontend"
          echo "Process: PM2 (frontend)"
          echo "Port: 3002"
          echo "==================================="
